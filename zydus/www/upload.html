{% extends "templates/zydus-portal-ui.html" %}
{% block title%}Upload{% endblock %}
{% block content%}
<link rel="stylesheet" href="/assets/zydus/css/dropzone.min.css" type="text/css" />
<link href="/assets/zydus/css/tagify.css" rel="stylesheet" />
<div class="row upload">
    <div class="col-lg-12 px-md-3 px-lg-5 px-xl-4 px-xxl-5 pt-5">
        <nav class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-link active" id="nav-project-link" data-bs-toggle="tab" href="#nav-project-content" role="tab"
                aria-controls="nav-project" aria-selected="true">Upload Project</a>
            <a class="nav-link" id="nav-data-link" data-bs-toggle="tab" href="#nav-data-content" role="tab"
                aria-controls="nav-data" aria-selected="false">Upload Data Sheet</a>

            <a class="nav-link" id="nav-saved-link" data-bs-toggle="tab" href="#nav-saved-content" role="tab"
                aria-controls="nav-saved" aria-selected="false">Saved</a>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-project-content" role="tabpanel"
                aria-labelledby="nav-project-link">
                {% set form = "upload-project" %}
                {% include "templates/zydus-portal-ui-includes/forms/project-form.html" %}
            </div>
            <div class="tab-pane fade" id="nav-data-content" role="tabpanel" aria-labelledby="nav-data-link">
                <div class="row gx-3 gy-3 mt-md-3">
                    <div class="col-12 col-lg-6 px-md-5">
                        <div class="p-xxl-5 h-100 d-flex align-items-center">
                            <div class="dropzone" id="upload-data-sheet-dropzone"></div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 px-lg-5">
                        {% include "templates/zydus-portal-ui-includes/forms/datasheet-form.html" %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="nav-saved-content" role="tabpanel" aria-labelledby="nav-saved-link">
                <div class="saved-nav-wrap">                    
                    <ul class="nav nav-pills saved-nav">
                        {% for saved in saved_projects %}
                        <li class="nav-item">
                            <a class="nav-link " onclick="loadSavedProject('{{saved.name}}')" aria-current="page" href="#">{{saved.title}}({{saved.brand}})</a>
                        </li>
                        {% endfor %}
                    </ul>                    
                </div>
               {% set form="upload-saved-project"%}
               {% set Saved = False  %}
               {% include "templates/zydus-portal-ui-includes/forms/project-form.html" %}
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content bg-primary">
            <div class="modal-body text-center">
                <img src="/assets/zydus/images/modal_check.svg">
                <div class="text-white mt-1">Project Successfully Uploaded</div>
                <div class="mt-4 d-flex flex-column modal-action-btns px-4">
                    <button onclick="location.reload()" class="btn btn-link text-white">Go to saved</button>
                    <button onclick="location.reload()" class="btn btn-link text-white">Go to upload</button>
                    <button onclick="location.href = '/home'" class="btn btn-link text-white">Go to home</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="saveModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="exampleModalLabel" style="display: none;"
    aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content bg-primary">
            <div class="modal-body text-center">
                <img src="/assets/zydus/images/modal_check.svg">
                <div class="text-white mt-1">Project Successfully Saved</div>
                <div class="mt-4 d-flex flex-column modal-action-btns px-4">
                    <button onclick="location.reload()" class="btn btn-link text-white">Go to saved</button>
                    <button onclick="location.reload()" class="btn btn-link text-white">Go to upload</button>
                    <button onclick="location.href = '/home'" class="btn btn-link text-white">Go to home</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/zydus/js/dropzone.min.js"></script>
<script src="/assets/zydus/js/tagify.min.js"></script>
<script src="/assets/zydus/js/tagify.polyfills.min.js"></script>
<script src="/assets/zydus/js/jquery.validate.min.js" integrity="sha512-37T7leoNS06R80c8Ulq7cdCDU5MNQBwlYoy1TX/WUsLFC2eYNqtKlV0QjH7r8JpG/S0GUMZwebnVFLPd6SU5yg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    Dropzone.options.uploadProjectDropzone = { // camelized version of the `id`
        paramName: "file", // The name that will be used to transfer the file
        headers: {
            "X-Frappe-CSRF-Token": frappe.csrf_token
        },
        maxFilesize: 2, // MB
        url: '/api/method/upload_file',
        params(files, xhr, chunk) {
            return {
                // make all uploaded files private in File DocType 
                is_private: 1
            }
        }
    };

    Dropzone.options.uploadDataSheetDropzone = { // camelized version of the `id`
        paramName: "file", // The name that will be used to transfer the file
        headers: {
            "X-Frappe-CSRF-Token": frappe.csrf_token
        },
        maxFilesize: 2, // MB
        url: '/api/method/upload_file',
        params(files, xhr, chunk) {
            return {
                // make all uploaded files private in File DocType 
                is_private: 1
            }
        }
    };

    Dropzone.options.uploadSavedProjectDropzone = { // camelized version of the `id`
        paramName: "file", // The name that will be used to transfer the file
        headers: {
            "X-Frappe-CSRF-Token": frappe.csrf_token
        },
        maxFilesize: 2, // MB
        url: '/api/method/upload_file',
        params(files, xhr, chunk) {
            return {
                // make all uploaded files private in File DocType 
                is_private: 1
            }
        }
    };

    // how to get uploaded files from particular dropzone
    // var dropzone = Dropzone.forElement('#upload-project-dropzone')
    // var uploaded_files = dropzone.getAcceptedFiles()
    // uploaded_files.forEach(x => {
    //     // getting xhr response of file upload api hit
    //     console.log(x.xhr.response)

    //     // getting name of File Document created
    //     var a = JSON.parse(x.xhr.response)
    //     console.log(a.message.name)
    // })

    // how to remove all files from particular dropzone
    // Dropzone.forElement('#upload-project-dropzone').removeAllFiles()
    
    // creating options for 25 years in the past
    var currentYear = new Date().getFullYear()
    for(var i = 1; i <= 25; i++) {
        $('select[name=year]').append('<option value="'+currentYear+'">'+currentYear+'</option>')
        currentYear--;
    }

    // populating brands
    var brands = {{brands}}
    for(var i = 0; i < brands.length; i++) {
        var brand = brands[i]
        $('select[name=brand]').append('<option value="'+brand+'">'+brand+'</option>')
    }

    // populating agencies
    var agencies = {{agencies}}
    for(var i = 0; i < agencies.length; i++) {
        var agency = agencies[i]
        $('select[name=agency]').append('<option value="'+agency+'">'+agency+'</option>')
    }

    // populating project_types
    var project_types = {{project_types}}
    for(var i = 0; i < project_types.length; i++) {
        var project_type = project_types[i]
        $('select[name=project_type]').append('<option value="'+project_type+'">'+project_type+'</option>')
    }
     
    // populating data_types
    var data_types = {{data_types}}
    for(var i = 0; i < data_types.length; i++) {
        var data_type = data_types[i]
        $('select[name=data_type]').append('<option value="'+data_type+'">'+data_type+'</option>')
    }

    // tagify markets input
    tagify = new Tagify($('[name=markets]').get(0), {
        whitelist : {{cities}},
        dropdown: {
            maxItems: 20,           // <- mixumum allowed rendered suggestions
            classname: "tags-look", // <- custom classname for this dropdown, so it could be targeted
            enabled: 0,             // <- show suggestions on focus
            closeOnSelect: false    // <- do not hide the suggestions dropdown once an item has been selected
        },
        enforceWhitelist: true
    })
     

    // Jquery Validator Defaults
    $.validator.setDefaults({
        validClass: 'is-valid',
        errorClass: 'is-invalid'
    });

    // Form validations
    $('#upload-project-form').validate({
        submitHandler: function(form) {
            // making sure attachments are added
            var dropzone = Dropzone.forElement('#upload-project-dropzone')
            var uploaded_files = dropzone.getAcceptedFiles()
            if(uploaded_files.length == 0) {
                alert('Files are mandatory')
                return
            }
            var dataArr = $(form).serializeArray()
            var obj = {}
            dataArr.forEach(x => {
                if(x.name == 'docstatus') {
                    x.value = parseInt(x.value)
                }
                obj[x.name] = x.value
            })
	    obj['workflow_state'] = 'Saved'

            // modifying markets json
            var marketsArr = JSON.parse($('#upload-project-form [name=markets]').val() || '[]')
            if(marketsArr.length > 0) {
                var markets = marketsArr.map(x => x.value)
                var markets_ = markets.map(x => {
                    return {'city': x}
                })
                obj['markets'] = markets_
            }
            console.log(obj, markets_)

            $.ajax({
                url: '/api/resource/Project',
                method: 'POST',
                data: JSON.stringify(obj),
                headers: {
                    'X-Frappe-CSRF-Token': frappe.csrf_token
                },
                success: function(res) {
                    console.log(res)
            
                    // adding tags to created document
                    var tagsArr = JSON.parse($('#upload-project-form [data-type=tags]').val() || '[]')
                    if(tagsArr.length > 0) {
                        var tags = tagsArr.map(x => x.value)
                        $.ajax({
                            url: '/api/method/frappe.desk.doctype.tag.tag.add_tags',
                            method: 'POST',
                            async: false,
                            headers: {
                                'X-Frappe-CSRF-Token': frappe.csrf_token
                            },
                            data: {
                                tags: JSON.stringify(tags),
                                dt: 'Project',
                                docs: JSON.stringify([res.data.name])
                            }
                        })
                    }

                    // adding attachments to created document
                    var dropzone = Dropzone.forElement('#upload-project-dropzone')
                    var uploaded_files = dropzone.getAcceptedFiles()
                    var uploaded_file_names = uploaded_files.map(x => {
                        // returning name of File Document created
                        var a = JSON.parse(x.xhr.response)
                        return a.message.name
                    })
                    $.ajax({
                        url: '/api/method/frappe.utils.file_manager.add_attachments',
                        method: 'POST',
                        async: false,
                        headers: {
                            'X-Frappe-CSRF-Token': frappe.csrf_token
                        },
                        data: {
                            doctype: 'Project',
                            name: res.data.name,
                            attachments: JSON.stringify(uploaded_file_names)
                        }
                    }) 
                    if($('#upload-project-form [name=workflow_state]').val()=="Pending"){
                        $.ajax({
                            url: '/api/resource/Project/'+ res.data.name,
                            method: 'PUT',
                            async: false,
                            data: JSON.stringify({workflow_state : "Pending"}),
                            headers: {
                                'X-Frappe-CSRF-Token': frappe.csrf_token
                            }   
                        })
                    }
                                 
                    
                    

                    // form house keeping
                    $('#upload-project-dropzone').trigger('reset')
                    Dropzone.forElement('#upload-project-dropzone').removeAllFiles()

                    // show modal
                    $('#saveModal').modal('show')
                }
            })
        }
    })

    function saveUploadForm() {
        // resetting form
        $('#upload-project-form').validate().resetForm()
        
        // setting submit inputs as not required
        $('#upload-project-form [name=month]').attr('required', false)
        $('#upload-project-form [name=year]').attr('required', false)
        $('#upload-project-form [name=agency]').attr('required', false)
        $('#upload-project-form [name=project_type]').attr('required', false)
        $('#upload-project-form [name=markets]').attr('required', true)
        $('#upload-project-form [name=workflow_state]').val("Saved")

        $('#upload-project-form').submit()
    }

    function submitUploadForm() {
        // resetting form
        $('#upload-project-form').validate().resetForm()
        
        // setting submit inputs as required
        $('#upload-project-form [name=month]').attr('required', true)
        $('#upload-project-form [name=year]').attr('required', true)
        $('#upload-project-form [name=agency]').attr('required', true)
        $('#upload-project-form [name=project_type]').attr('required', true)
        $('#upload-project-form [name=markets]').attr('required', true)
        $('#upload-project-form [name=workflow_state]').val("Pending")

        $('#upload-project-form').submit()
    }
    
    $('#upload-datasheet-form').validate({
        submitHandler: function(form) {
            // making sure attachments are added
            var dropzone = Dropzone.forElement('#upload-data-sheet-dropzone')
            var uploaded_files = dropzone.getAcceptedFiles()
            if(uploaded_files.length == 0) {
                alert('Files are mandatory')
                return
            }

            var dataArr = $(form).serializeArray()
            var obj = {}
            dataArr.forEach(x => {
                if(x.name == 'docstatus') {
                    x.value = parseInt(x.value)
                }
                obj[x.name] = x.value
            })

            $.ajax({
                url: '/api/resource/Datasheet',
                method: 'POST',
                data: JSON.stringify(obj),
                headers: {
                    'X-Frappe-CSRF-Token': frappe.csrf_token
                },
                success: function(res) {
                    console.log(res)

                    // adding tags to created document
                    var tagsArr = JSON.parse($('#upload-datasheet-form [data-type=tags]').val())
                    var tags = tagsArr.map(x => x.value)
                    $.ajax({
                        url: '/api/method/frappe.desk.doctype.tag.tag.add_tags',
                        method: 'POST',
                        async: false,
                        headers: {
                            'X-Frappe-CSRF-Token': frappe.csrf_token
                        },
                        data: {
                            tags: JSON.stringify(tags),
                            dt: 'Datasheet',
                            docs: JSON.stringify([res.data.name])
                        }
                    })


                    // adding attachments to created document
                    var uploaded_file_names = uploaded_files.map(x => {
                        // returning name of File Document created
                        var a = JSON.parse(x.xhr.response)
                        return a.message.name
                    })
                    $.ajax({
                        url: '/api/method/frappe.utils.file_manager.add_attachments',
                        method: 'POST',
                        async: false,
                        headers: {
                            'X-Frappe-CSRF-Token': frappe.csrf_token
                        },
                        data: {
                            doctype: 'Datasheet',
                            name: res.data.name,
                            attachments: JSON.stringify(uploaded_file_names)
                        }
                    })
                    $.ajax({
                        url: '/api/resource/Datasheet/'+ res.data.name,
                        method: 'PUT',
                        data: JSON.stringify({workflow_state : "Pending"}),
                        headers: {
                            'X-Frappe-CSRF-Token': frappe.csrf_token
                        }   
                    })

                    

                    // form house keeping
                    $('#upload-data-sheet-dropzone').trigger('reset')
                    Dropzone.forElement('#upload-data-sheet-dropzone').removeAllFiles()

                    // show modal
                    $('#saveModal').modal('show')
                }
            })
        }
    })

    function submitDatasheetForm() {
        
        $('#upload-datasheet-form').validate().resetForm()
        
        // setting submit inputs as required
        $('#upload-datasheet-form [name=agency]').attr('required', true)
        $('#upload-datasheet-form [name=data_type]').attr('required',true)
        $('#upload-datasheet-form [name=docstatus]').val(0)

        $('#upload-datasheet-form').submit()
    }
    function loadSavedProject(projectName){
       
        $.ajax({
                url: '/api/method/frappe.desk.form.load.getdoc',
               
                data: {
                    doctype: 'Project',
                    name: projectName
                },
                method: 'GET',
                
                success: function(res) {
                    console.log(res)
                    //console.log(res.docs[0].markets[0].city)
                   // console.log(res.docs[0].markets.length)
                    mar_array=[]
                    for(var i = 0;i < res.docs[0].markets.length;i++)
                    { 
                        
                        //console.log(res.docs[0].markets[i].city)
                        //console.log(typeof res.docs[0].markets[i].city)
                        
                        mar_array.push(res.docs[0].markets[i].city)
                    }

                    // console.log(mar_array)
                    var find_mar=mar_array.toString()
                    console.log(find_mar)

                    $('#upload-saved-project-form [name=brand]').val(res.docs[0].brand)
                    $('#upload-saved-project-form [name=project_type]').val(res.docs[0].project_type)
                    $('#upload-saved-project-form [name=agency]').val(res.docs[0].agency)
                    $('#upload-saved-project-form [name=actions]').val(res.docs[0].actions)
                    $('#upload-saved-project-form [name=business_problemsd]').val(res.docs[0].business_problems)
                    $('#upload-saved-project-form [name=description]').val(res.docs[0].description)
                    $('#upload-saved-project-form [name=learnings]').val(res.docs[0].learnings)
                    $('#upload-saved-project-form [name=month]').val(res.docs[0].month)
                    $('#upload-saved-project-form [name=name]').val(res.docs[0].name)
                    $('#upload-saved-project-form [name=research_objectives]').val(res.docs[0].research_objectives)
                    $('#upload-saved-project-form [name=result]').val(res.docs[0].result)
                    $('#upload-saved-project-form [name=target_group]').val(res.docs[0].target_group)
                    $('#upload-saved-project-form [name=title]').val(res.docs[0].title)
                    $('#upload-saved-project-form [name=doctype]').val(res.docs[0].doctype)
                    $('#upload-saved-project-form [name=workflow_state]').val(res.docs[0].workflow_state)
                    $('#upload-saved-project-form [name=year]').val(res.docs[0].year)
                    $('#upload-saved-project-form [data-type=tags]').val(JSON.stringify(res.docs[0]._user_tags.split(',').splice(1).map(x => {return {value:x}})))
                    $('#upload-saved-project-form [name=markets]').val(find_mar)
                  

                }
        })


    }
    
</script>
{% endblock %}
